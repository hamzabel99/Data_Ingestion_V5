import boto3
import json
from datetime import datetime
import os

# Initialisation DynamoDB
dynamodb = boto3.resource("dynamodb")
WORKFLOW_STATUS_TABLE = os.environ.get("WORKFLOW_STATUS_TABLE")
table = dynamodb.Table(WORKFLOW_STATUS_TABLE)

def lambda_handler(event, context):
    """
    Event attendu depuis Step Function :
    {
      "input_bucket": "...",
      "s3_key": "...",
      "--input_event": {
        "files_to_process": [...]
      }
    }
    """
    
    print(f"üì• Event re√ßu: {json.dumps(event, indent=2)}")
    
    # R√©cup√©rer les fichiers √† traiter
    files_to_process = []
    
    # Cas 1: --input_event contient l'objet complet
    if "--input_event" in event:
        input_event = event["--input_event"]
        
        # Si c'est un string JSON, le d√©coder
        if isinstance(input_event, str):
            input_event = json.loads(input_event)
        
        # Extraire files_to_process
        if isinstance(input_event, dict):
            files_to_process = input_event.get("files_to_process", [])
        elif isinstance(input_event, list):
            # Si c'est directement un array de fichiers
            files_to_process = input_event
    
    # Cas 2: Fallback - chercher files_to_process √† la racine
    elif "files_to_process" in event:
        files_to_process = event["files_to_process"]
    
    else:
        raise ValueError("Impossible de trouver les fichiers √† traiter dans l'event")
    
    if not files_to_process:
        print("‚ö†Ô∏è Aucun fichier trouv√© dans files_to_process")
        return {"updated": 0}

    print(f"üìÅ {len(files_to_process)} fichiers √† marquer comme DONE")
    
    updated_count = 0
    for f in files_to_process:
        s3_key = f["s3_key"]

        try:
            # Mettre √† jour DynamoDB pour chaque fichier
            table.update_item(
                Key={"s3_prefix": s3_key},
                UpdateExpression="SET end_time = :et, #st = :st",
                ExpressionAttributeValues={
                    ":et": datetime.utcnow().isoformat(),
                    ":st": "DONE",
                },
                ExpressionAttributeNames={
                    "#st": "status"  # status est un mot r√©serv√©
                },
            )
            updated_count += 1
            print(f"‚úÖ Fichier {s3_key} marqu√© DONE")
            
        except Exception as e:
            print(f"‚ùå Erreur lors de la mise √† jour de {s3_key}: {e}")
            raise

    print(f"üéâ Workflow termin√© - {updated_count} fichiers mis √† jour")
    return {
        "updated": updated_count,
        "files_processed": [f["s3_key"] for f in files_to_process]
    }